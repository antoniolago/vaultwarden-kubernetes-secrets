name: Local Testing (Act)

on:
  workflow_dispatch:
  pull_request:

jobs:
  build-and-test:
    name: Build and Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET 9.0.x
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Restore dependencies
      run: dotnet restore

    - name: Build project
      run: dotnet build --no-restore --configuration Release

    - name: Run unit tests
      run: dotnet test --no-build --verbosity normal --configuration Release

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check for TODO comments
      run: |
        if grep -r "TODO" VaultwardenK8sSync/ --include="*.cs"; then
          echo "‚ùå Found TODO comments in source code - please resolve before merging"
          exit 1
        fi
        echo "‚úÖ No TODO comments found"

    - name: Check for FIXME comments
      run: |
        if grep -r "FIXME" VaultwardenK8sSync/ --include="*.cs"; then
          echo "‚ùå Found FIXME comments in source code - please resolve before merging"
          exit 1
        fi
        echo "‚úÖ No FIXME comments found"

  infrastructure-validation:
    name: Infrastructure Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Helm
      uses: azure/setup-helm@v4
      with:
        version: v3.14.4

    - name: Validate Helm chart structure
      run: |
        echo "üîç Validating Helm chart structure..."
        helm lint charts/vaultwarden-k8s-sync
        echo "‚úÖ Helm chart validation passed"

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Validate Dockerfile syntax
      run: |
        echo "üîç Validating Dockerfile syntax..."
        docker build --check -f VaultwardenK8sSync/Dockerfile VaultwardenK8sSync/
        echo "‚úÖ Dockerfile validation passed"

  test-helm-chart:
    name: Test Helm Chart Installation
    runs-on: ubuntu-latest
    needs: [infrastructure-validation]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.4
      
      - name: Create kind cluster
        uses: helm/kind-action@v1
        with:
          cluster_name: test-cluster
          wait: 30s
      
      - name: Create test namespace
        run: kubectl create namespace vaultwarden-test
      
      - name: Create test secrets
        run: |
          kubectl create secret generic vaultwarden-kubernetes-secrets -n vaultwarden-test \
            --from-literal=BW_CLIENTID="test-client-id" \
            --from-literal=BW_CLIENTSECRET="test-client-secret" \
            --from-literal=VAULTWARDEN__MASTERPASSWORD="test-password"
      
      - name: Install Helm chart (dry-run mode)
        run: |
          helm upgrade -i vaultwarden-test ./charts/vaultwarden-k8s-sync \
            --namespace vaultwarden-test \
            --set image.repository=ghcr.io/${{ github.repository_owner }}/vaultwarden-k8s-sync \
            --set image.tag=latest \
            --set env.config.VAULTWARDEN__SERVERURL="https://test.example.com" \
            --set env.config.SYNC__DRYRUN="true" \
            --set env.config.SYNC__CONTINUOUSSYNC="false" \
            --wait --timeout 2m
      
      - name: Verify deployment
        run: |
          kubectl get pods -n vaultwarden-test
          kubectl get deployment -n vaultwarden-test
          kubectl describe deployment vaultwarden-test-vaultwarden-k8s-sync -n vaultwarden-test
      
      - name: Check pod logs
        if: always()
        run: |
          POD_NAME=$(kubectl get pods -n vaultwarden-test -l app.kubernetes.io/name=vaultwarden-k8s-sync -o jsonpath='{.items[0].metadata.name}')
          if [ -n "$POD_NAME" ]; then
            echo "üìã Pod logs:"
            kubectl logs $POD_NAME -n vaultwarden-test --tail=50 || true
          fi
      
      - name: Cleanup
        if: always()
        run: kubectl delete namespace vaultwarden-test --ignore-not-found=true
