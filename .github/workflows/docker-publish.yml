name: Build and Push Image

on:
  push:
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

jobs:
  build-and-test:
    name: Build and Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET 9.0.x
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'

    - name: Restore dependencies
      run: dotnet restore

    - name: Build project
      run: dotnet build --no-restore --configuration Release

    - name: Run unit tests
      run: dotnet test --no-build --verbosity normal --configuration Release

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check for TODO comments
      run: |
        if grep -r "TODO" VaultwardenK8sSync/ --include="*.cs"; then
          echo "âŒ Found TODO comments in source code - please resolve before merging"
          exit 1
        fi
        echo "âœ… No TODO comments found"

    - name: Check for FIXME comments
      run: |
        if grep -r "FIXME" VaultwardenK8sSync/ --include="*.cs"; then
          echo "âŒ Found FIXME comments in source code - please resolve before merging"
          exit 1
        fi
        echo "âœ… No FIXME comments found"

  infrastructure-validation:
    name: Infrastructure Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Helm
      uses: azure/setup-helm@v4
      with:
        version: v3.14.4

    - name: Validate Helm chart structure
      run: |
        echo "ðŸ” Validating Helm chart structure..."
        helm lint charts/vaultwarden-kubernetes-secrets
        echo "âœ… Helm chart validation passed"

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Validate Dockerfile syntax
      run: |
        echo "ðŸ” Validating Dockerfile syntax..."
        docker build --check -f VaultwardenK8sSync/Dockerfile .
        echo "âœ… Dockerfile validation passed"

  security:
    name: Security and Dependency Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET 9.0.x
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'

    - name: Restore dependencies
      run: dotnet restore

    - name: Check for vulnerable packages
      run: |
        echo "ðŸ” Checking for vulnerable NuGet packages..."
        dotnet list package --vulnerable
        echo "âœ… Package vulnerability check completed"

    - name: Run dependency check
      run: |
        echo " Running dependency evaluation..."
        dotnet restore --force-evaluate
        echo " Dependency check completed"

  prepare-versions:
    name: Calculate Version Tags
    runs-on: ubuntu-latest
    needs: [build-and-test, code-quality, infrastructure-validation, security]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    outputs:
      raw_tag: ${{ steps.vars.outputs.raw_tag }}
      version: ${{ steps.vars.outputs.version }}
      pr_tag: ${{ steps.vars.outputs.pr_tag }}
      is_release: ${{ steps.vars.outputs.is_release }}
    
    steps:
      - name: Extract version and create tags
        id: vars
        run: |
           if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/* ]]; then
             RAW_TAG="${GITHUB_REF_NAME}"
             VERSION="${RAW_TAG#v}"
             echo "raw_tag=${RAW_TAG}" >> $GITHUB_OUTPUT
             echo "version=${VERSION}" >> $GITHUB_OUTPUT
             echo "pr_tag=" >> $GITHUB_OUTPUT
             echo "is_release=true" >> $GITHUB_OUTPUT
           elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
             PR_NUMBER="${{ github.event.number }}"
             COMMIT_SHA="${GITHUB_SHA::8}"
             PR_TAG="pr-${PR_NUMBER}-${COMMIT_SHA}"
             echo "raw_tag=${PR_TAG}" >> $GITHUB_OUTPUT
             echo "version=0.0.0-pr${PR_NUMBER}" >> $GITHUB_OUTPUT
             echo "pr_tag=${PR_TAG}" >> $GITHUB_OUTPUT
             echo "is_release=false" >> $GITHUB_OUTPUT
           else
             BRANCH_NAME="${GITHUB_REF_NAME//\//-}"
             COMMIT_SHA="${GITHUB_SHA::8}"
             BRANCH_TAG="${BRANCH_NAME}-${COMMIT_SHA}"
             echo "raw_tag=${BRANCH_TAG}" >> $GITHUB_OUTPUT
             echo "version=0.0.0-${BRANCH_NAME}" >> $GITHUB_OUTPUT
             echo "pr_tag=" >> $GITHUB_OUTPUT
             echo "is_release=false" >> $GITHUB_OUTPUT
           fi

  build-sync:
    name: Build Sync Worker
    runs-on: ubuntu-latest
    needs: [prepare-versions]
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Harbor
        uses: docker/login-action@v3
        with:
          registry: harbor.lag0.com.br
          username: ${{ secrets.HARBOR_USERNAME }}
          password: ${{ secrets.HARBOR_PASSWORD }}

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push sync worker
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./VaultwardenK8sSync/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') && format('ghcr.io/{0}/vaultwarden-kubernetes-secrets:latest', github.repository_owner) || '' }}
            ghcr.io/${{ github.repository_owner }}/vaultwarden-kubernetes-secrets:${{ needs.prepare-versions.outputs.raw_tag }}
            ${{ github.event_name != 'pull_request' && format('ghcr.io/{0}/vaultwarden-kubernetes-secrets:{1}', github.repository_owner, needs.prepare-versions.outputs.version) || '' }}
            ${{ github.event_name != 'pull_request' && 'harbor.lag0.com.br/library/vaultwarden-kubernetes-secrets:latest' || '' }}
            ${{ github.event_name != 'pull_request' && format('harbor.lag0.com.br/library/vaultwarden-kubernetes-secrets:{0}', needs.prepare-versions.outputs.raw_tag) || '' }}
            ${{ github.event_name != 'pull_request' && format('harbor.lag0.com.br/library/vaultwarden-kubernetes-secrets:{0}', needs.prepare-versions.outputs.version) || '' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-api:
    name: Build API
    runs-on: ubuntu-latest
    needs: [prepare-versions]
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Harbor
        uses: docker/login-action@v3
        with:
          registry: harbor.lag0.com.br
          username: ${{ secrets.HARBOR_USERNAME }}
          password: ${{ secrets.HARBOR_PASSWORD }}

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push API
        uses: docker/build-push-action@v6
        with:
          context: .
          file: VaultwardenK8sSync.Api/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') && format('ghcr.io/{0}/vaultwarden-kubernetes-secrets-api:latest', github.repository_owner) || '' }}
            ghcr.io/${{ github.repository_owner }}/vaultwarden-kubernetes-secrets-api:${{ needs.prepare-versions.outputs.raw_tag }}
            ${{ github.event_name != 'pull_request' && format('ghcr.io/{0}/vaultwarden-kubernetes-secrets-api:{1}', github.repository_owner, needs.prepare-versions.outputs.version) || '' }}
            ${{ github.event_name != 'pull_request' && 'harbor.lag0.com.br/library/vaultwarden-kubernetes-secrets-api:latest' || '' }}
            ${{ github.event_name != 'pull_request' && format('harbor.lag0.com.br/library/vaultwarden-kubernetes-secrets-api:{0}', needs.prepare-versions.outputs.raw_tag) || '' }}
            ${{ github.event_name != 'pull_request' && format('harbor.lag0.com.br/library/vaultwarden-kubernetes-secrets-api:{0}', needs.prepare-versions.outputs.version) || '' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-dashboard:
    name: Build Dashboard
    runs-on: ubuntu-latest
    needs: [prepare-versions]
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Harbor
        uses: docker/login-action@v3
        with:
          registry: harbor.lag0.com.br
          username: ${{ secrets.HARBOR_USERNAME }}
          password: ${{ secrets.HARBOR_PASSWORD }}

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push dashboard
        uses: docker/build-push-action@v6
        with:
          context: dashboard
          file: dashboard/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') && format('ghcr.io/{0}/vaultwarden-kubernetes-secrets-dashboard:latest', github.repository_owner) || '' }}
            ghcr.io/${{ github.repository_owner }}/vaultwarden-kubernetes-secrets-dashboard:${{ needs.prepare-versions.outputs.raw_tag }}
            ${{ github.event_name != 'pull_request' && format('ghcr.io/{0}/vaultwarden-kubernetes-secrets-dashboard:{1}', github.repository_owner, needs.prepare-versions.outputs.version) || '' }}
            ${{ github.event_name != 'pull_request' && 'harbor.lag0.com.br/library/vaultwarden-kubernetes-secrets-dashboard:latest' || '' }}
            ${{ github.event_name != 'pull_request' && format('harbor.lag0.com.br/library/vaultwarden-kubernetes-secrets-dashboard:{0}', needs.prepare-versions.outputs.raw_tag) || '' }}
            ${{ github.event_name != 'pull_request' && format('harbor.lag0.com.br/library/vaultwarden-kubernetes-secrets-dashboard:{0}', needs.prepare-versions.outputs.version) || '' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  package-helm:
    name: Package and Push Helm Chart
    runs-on: ubuntu-latest
    needs: [prepare-versions, build-sync, build-api, build-dashboard]
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.4

      - name: Log in to Harbor
        uses: docker/login-action@v3
        with:
          registry: harbor.lag0.com.br
          username: ${{ secrets.HARBOR_USERNAME }}
          password: ${{ secrets.HARBOR_PASSWORD }}

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Helm lint chart
        run: helm lint charts/vaultwarden-kubernetes-secrets

      - name: Package Helm chart
        run: |
          mkdir -p dist
          helm package charts/vaultwarden-kubernetes-secrets \
            --version "${{ needs.prepare-versions.outputs.version }}" \
            --app-version "${{ needs.prepare-versions.outputs.version }}" \
            --destination dist

          
      - name: Push Helm chart to GHCR
        run: |
          CHART_FILE="dist/vaultwarden-kubernetes-secrets-${{ needs.prepare-versions.outputs.version }}.tgz"
          if [ ! -f "$CHART_FILE" ]; then
            echo "Error: Chart file $CHART_FILE not found!"
            ls -la dist/ || true
            exit 1
          fi
          helm push "$CHART_FILE" oci://ghcr.io/${{ github.repository_owner }}/charts
      
      - name: Push Helm chart to Harbor
        run: |
          CHART_FILE="dist/vaultwarden-kubernetes-secrets-${{ needs.prepare-versions.outputs.version }}.tgz"
          helm push "$CHART_FILE" oci://harbor.lag0.com.br/charts

  # test-helm-chart:
  #   name: Test Helm Chart Installation
  #   runs-on: ubuntu-latest
  #   needs: [build-and-push]
  #   if: github.event_name == 'pull_request' || startsWith(github.ref, 'refs/tags/')
    
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
      
  #     - name: Set up Helm
  #       uses: azure/setup-helm@v4
  #       with:
  #         version: v3.14.4
      
  #     - name: Create kind cluster
  #       uses: helm/kind-action@v1
  #       with:
  #         cluster_name: test-cluster
  #         wait: 30s
      
  #     - name: Extract version tag
  #       id: vars
  #       run: |
  #         if [[ "${{ github.event_name }}" == "pull_request" ]]; then
  #           PR_NUMBER="${{ github.event.number }}"
  #           COMMIT_SHA="${GITHUB_SHA::8}"
  #           IMAGE_TAG="pr-${PR_NUMBER}-${COMMIT_SHA}"
  #         else
  #           IMAGE_TAG="${GITHUB_REF_NAME#v}"
  #         fi
  #         echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
      
  #     - name: Create test namespace
  #       run: kubectl create namespace vaultwarden-test
      
  #     - name: Create test secrets
  #       run: |
  #         kubectl create secret generic vaultwarden-kubernetes-secrets -n vaultwarden-test \
  #           --from-literal=BW_CLIENTID="test-client-id" \
  #           --from-literal=BW_CLIENTSECRET="test-client-secret" \
  #           --from-literal=VAULTWARDEN__MASTERPASSWORD="test-password"
      
  #     - name: Verify image exists in registry
  #       run: |
  #         echo "ðŸ” Verifying image exists in GHCR..."
  #         IMAGE_NAME="ghcr.io/${{ github.repository_owner }}/vaultwarden-kubernetes-secrets:${{ steps.vars.outputs.image_tag }}"
  #         echo "Image: $IMAGE_NAME"
          
  #         # Try to inspect the image manifest
  #         if docker manifest inspect "$IMAGE_NAME" >/dev/null 2>&1; then
  #           echo "âœ… Image exists and is accessible"
  #         else
  #           echo "âŒ Image not found or not accessible"
  #           echo "Attempting to pull to verify..."
  #           docker pull "$IMAGE_NAME" || {
  #             echo "âŒ Failed to pull image"
  #             echo "This usually means:"
  #             echo "  1. Image wasn't pushed successfully in previous step"
  #             echo "  2. Image is private and credentials aren't configured"
  #             echo "  3. Tag name is incorrect"
  #             exit 1
  #           }
  #         fi
      
  #     - name: Install Helm chart (debug mode)
  #       run: |
  #         echo "ðŸš€ Installing Helm chart with debug mode..."
  #         echo "Image: ghcr.io/${{ github.repository_owner }}/vaultwarden-kubernetes-secrets:${{ steps.vars.outputs.image_tag }}"
          
  #         # Install without --wait first to see what gets created
  #         helm upgrade -i vaultwarden-test ./charts/vaultwarden-kubernetes-secrets \
  #           --namespace vaultwarden-test \
  #           --set image.repository=ghcr.io/${{ github.repository_owner }}/vaultwarden-kubernetes-secrets \
  #           --set image.tag=${{ steps.vars.outputs.image_tag }} \
  #           --set debug=true \
  #           --set api.enabled=false \
  #           --set dashboard.enabled=false
          
  #         echo ""
  #         echo "â³ Waiting for deployment (manual check with timeout)..."
          
  #         # Wait up to 120 seconds for pod to be running
  #         for i in {1..24}; do
  #           echo "Attempt $i/24: Checking pod status..."
            
  #           POD_STATUS=$(kubectl get pods -n vaultwarden-test -l app.kubernetes.io/name=vaultwarden-kubernetes-secrets -o jsonpath='{.items[0].status.phase}' 2>/dev/null || echo "NotFound")
  #           echo "  Pod phase: $POD_STATUS"
            
  #           if [ "$POD_STATUS" == "Running" ]; then
  #             READY=$(kubectl get pods -n vaultwarden-test -l app.kubernetes.io/name=vaultwarden-kubernetes-secrets -o jsonpath='{.items[0].status.containerStatuses[0].ready}' 2>/dev/null || echo "false")
  #             if [ "$READY" == "true" ]; then
  #               echo "âœ… Pod is running and ready!"
  #               break
  #             else
  #               echo "  Container not ready yet..."
  #               kubectl get pods -n vaultwarden-test -o wide
  #               kubectl describe pod -n vaultwarden-test -l app.kubernetes.io/name=vaultwarden-kubernetes-secrets | tail -30
  #             fi
  #           elif [ "$POD_STATUS" == "Pending" ] || [ "$POD_STATUS" == "ContainerCreating" ]; then
  #             echo "  Pod is starting..."
  #             kubectl get pods -n vaultwarden-test -o wide
  #           else
  #             echo "  âš ï¸ Unexpected status: $POD_STATUS"
  #             kubectl get pods -n vaultwarden-test -o wide
  #             kubectl describe pod -n vaultwarden-test -l app.kubernetes.io/name=vaultwarden-kubernetes-secrets | tail -50
  #             kubectl get events -n vaultwarden-test --sort-by='.lastTimestamp' | tail -20
  #           fi
            
  #           if [ $i -lt 24 ]; then
  #             sleep 5
  #           else
  #             echo "âŒ Timeout waiting for pod to be ready"
  #             exit 1
  #           fi
  #         done
      
  #     - name: Verify deployment
  #       run: |
  #         echo "ðŸ“‹ Checking deployment status..."
  #         kubectl get pods -n vaultwarden-test -o wide
  #         kubectl get deployment -n vaultwarden-test -o wide
          
  #         echo ""
  #         echo "ðŸ§ª Running verification tests..."
          
  #         # Test 1: Pod is running
  #         READY_PODS=$(kubectl get pods -n vaultwarden-test -l app.kubernetes.io/name=vaultwarden-kubernetes-secrets -o jsonpath='{.items[?(@.status.phase=="Running")].metadata.name}')
  #         if [ -n "$READY_PODS" ]; then
  #           echo "âœ… Pod is running: $READY_PODS"
  #         else
  #           echo "âŒ No running pods found"
  #           kubectl describe deployment vaultwarden-test-vaultwarden-kubernetes-secrets -n vaultwarden-test
  #           exit 1
  #         fi
          
  #         # Test 2: No API/Dashboard pods
  #         API_PODS=$(kubectl get pods -n vaultwarden-test -l app.kubernetes.io/component=api -o name 2>/dev/null | wc -l)
  #         DASH_PODS=$(kubectl get pods -n vaultwarden-test -l app.kubernetes.io/component=dashboard -o name 2>/dev/null | wc -l)
  #         if [ "$API_PODS" -eq 0 ] && [ "$DASH_PODS" -eq 0 ]; then
  #           echo "âœ… API and Dashboard correctly disabled"
  #         else
  #           echo "âŒ Unexpected API/Dashboard pods found"
  #           exit 1
  #         fi
          
  #         echo ""
  #         echo "âœ… All verification tests passed!"
      
  #     - name: Check pod logs and diagnostics
  #       if: always()
  #       run: |
  #         echo "ðŸ“Š Complete Diagnostic Report"
  #         echo "=============================="
  #         echo ""
          
  #         echo "ðŸ“‹ All pods in namespace:"
  #         kubectl get pods -n vaultwarden-test -o wide || true
  #         echo ""
          
  #         echo "ðŸ“‹ Deployments:"
  #         kubectl get deployment -n vaultwarden-test -o wide || true
  #         echo ""
          
  #         echo "ðŸ“‹ ReplicaSets:"
  #         kubectl get rs -n vaultwarden-test -o wide || true
  #         echo ""
          
  #         echo "ðŸ“‹ Recent events:"
  #         kubectl get events -n vaultwarden-test --sort-by='.lastTimestamp' | tail -30 || true
  #         echo ""
          
  #         POD_NAME=$(kubectl get pods -n vaultwarden-test -l app.kubernetes.io/name=vaultwarden-kubernetes-secrets -o jsonpath='{.items[0].metadata.name}' 2>/dev/null)
  #         if [ -n "$POD_NAME" ]; then
  #           echo "ðŸ“‹ Pod: $POD_NAME"
  #           echo ""
            
  #           echo "ðŸ“‹ Init container logs (if any):"
  #           kubectl logs $POD_NAME -n vaultwarden-test -c init-permissions --tail=50 2>&1 || echo "No init container logs"
  #           echo ""
            
  #           echo "ðŸ“‹ Main container logs:"
  #           kubectl logs $POD_NAME -n vaultwarden-test --tail=100 2>&1 || echo "No main container logs"
  #           echo ""
            
  #           echo "ðŸ“‹ Pod description:"
  #           kubectl describe pod $POD_NAME -n vaultwarden-test || true
  #         else
  #           echo "âš ï¸  No pods found with label app.kubernetes.io/name=vaultwarden-kubernetes-secrets"
  #         fi
      
  #     - name: Cleanup
  #       if: always()
  #       run: kubectl delete namespace vaultwarden-test --ignore-not-found=true

  comment-pr:
    runs-on: ubuntu-latest
    needs: [package-helm]
    if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
    permissions:
      contents: read
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate PR tag
        id: vars
        run: |
          PR_NUMBER="${{ github.event.number }}"
          COMMIT_SHA="${GITHUB_SHA::8}"
          PR_TAG="pr-${PR_NUMBER}-${COMMIT_SHA}"
          echo "pr_tag=${PR_TAG}" >> $GITHUB_OUTPUT

      - name: Comment on PR with Docker image info
        uses: actions/github-script@v7
        with:
          script: |
            const commentBody = `## âœ… PR Build & Test Complete

            **Docker Image:** \`ghcr.io/${context.repo.owner}/vaultwarden-kubernetes-secrets:${process.env.PR_TAG}\`
            
            **Helm Chart:** âœ… Tested and validated in kind cluster

            ### Quick Test Commands

            **Using Helm:**
            \`\`\`bash
            helm upgrade -i vaultwarden-test oci://ghcr.io/${context.repo.owner}/charts/vaultwarden-kubernetes-secrets \\
              --set image.tag=${process.env.PR_TAG} \\
              --set env.config.VAULTWARDEN__SERVERURL="https://your-server.com" \\
              --namespace vaultwarden-test --create-namespace
            \`\`\`

            **Using kubectl:**
            \`\`\`bash
            kubectl set image deployment/vaultwarden-kubernetes-secrets \\
              vaultwarden-kubernetes-secrets=ghcr.io/${context.repo.owner}/vaultwarden-kubernetes-secrets:${process.env.PR_TAG}
            \`\`\`

            ---
            ðŸ“¦ Build SHA: \`${process.env.GITHUB_SHA}\` | ðŸ• ${new Date().toISOString()}`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            // Check if we already commented on this PR
            const existingComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('PR Build & Test Complete')
            );
            
            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: commentBody
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }
        env:
          PR_TAG: ${{ steps.vars.outputs.pr_tag }}

      