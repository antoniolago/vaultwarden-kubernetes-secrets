name: Build and Push Image

on:
  push:
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

jobs:
  build-and-test:
    name: Build and Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET 9.0.x
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Restore dependencies
      run: dotnet restore

    - name: Build project
      run: dotnet build --no-restore --configuration Release

    - name: Run unit tests
      run: dotnet test --no-build --verbosity normal --configuration Release

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check for TODO comments
      run: |
        if grep -r "TODO" VaultwardenK8sSync/ --include="*.cs"; then
          echo "âŒ Found TODO comments in source code - please resolve before merging"
          exit 1
        fi
        echo "âœ… No TODO comments found"

    - name: Check for FIXME comments
      run: |
        if grep -r "FIXME" VaultwardenK8sSync/ --include="*.cs"; then
          echo "âŒ Found FIXME comments in source code - please resolve before merging"
          exit 1
        fi
        echo "âœ… No FIXME comments found"

  infrastructure-validation:
    name: Infrastructure Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Helm
      uses: azure/setup-helm@v4
      with:
        version: v3.14.4

    - name: Validate Helm chart structure
      run: |
        echo "ðŸ” Validating Helm chart structure..."
        helm lint charts/vaultwarden-kubernetes-secrets
        echo "âœ… Helm chart validation passed"

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Validate Dockerfile syntax
      run: |
        echo "ðŸ” Validating Dockerfile syntax..."
        docker build --check -f VaultwardenK8sSync/Dockerfile VaultwardenK8sSync/
        echo "âœ… Dockerfile validation passed"

  security:
    name: Security and Dependency Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET 9.0.x
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Restore dependencies
      run: dotnet restore

    - name: Check for vulnerable packages
      run: |
        echo "ðŸ” Checking for vulnerable NuGet packages..."
        dotnet list package --vulnerable
        echo "âœ… Package vulnerability check completed"

    - name: Run dependency check
      run: |
        echo "ðŸ” Running dependency evaluation..."
        dotnet restore --force-evaluate
        echo "âœ… Dependency check completed"

  build-and-push:
    runs-on: ubuntu-latest
    needs: [build-and-test, code-quality, infrastructure-validation, security]
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Harbor Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: harbor.lag0.com.br
          username: ${{ secrets.HARBOR_USERNAME }}
          password: ${{ secrets.HARBOR_PASSWORD }}

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version and create tags
        id: vars
        run: |
           if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/* ]]; then
             # Tag push - use the tag name
             RAW_TAG="${GITHUB_REF_NAME}"
             VERSION="${RAW_TAG#v}"
             echo "raw_tag=${RAW_TAG}" >> $GITHUB_OUTPUT
             echo "version=${VERSION}" >> $GITHUB_OUTPUT
             echo "pr_tag=" >> $GITHUB_OUTPUT
             echo "is_release=true" >> $GITHUB_OUTPUT
           elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
             # PR - create PR-specific tag
             PR_NUMBER="${{ github.event.number }}"
             COMMIT_SHA="${GITHUB_SHA::8}"
             PR_TAG="pr-${PR_NUMBER}-${COMMIT_SHA}"
             echo "raw_tag=${PR_TAG}" >> $GITHUB_OUTPUT
             echo "version=0.0.0-pr${PR_NUMBER}" >> $GITHUB_OUTPUT
             echo "pr_tag=${PR_TAG}" >> $GITHUB_OUTPUT
             echo "is_release=false" >> $GITHUB_OUTPUT
           else
             # Branch push - use branch name and commit SHA
             BRANCH_NAME="${GITHUB_REF_NAME//\//-}"
             COMMIT_SHA="${GITHUB_SHA::8}"
             BRANCH_TAG="${BRANCH_NAME}-${COMMIT_SHA}"
             echo "raw_tag=${BRANCH_TAG}" >> $GITHUB_OUTPUT
             echo "version=0.0.0-${BRANCH_NAME}" >> $GITHUB_OUTPUT
             echo "pr_tag=" >> $GITHUB_OUTPUT
             echo "is_release=false" >> $GITHUB_OUTPUT
           fi

      - name: Build and push to GHCR (all scenarios)
        uses: docker/build-push-action@v6
        with:
          context: ./VaultwardenK8sSync
          file: ./VaultwardenK8sSync/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') && format('ghcr.io/{0}/vaultwarden-kubernetes-secrets:latest', github.repository_owner) || '' }}
            ghcr.io/${{ github.repository_owner }}/vaultwarden-kubernetes-secrets:${{ steps.vars.outputs.raw_tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push PR-specific tag
        if: steps.vars.outputs.pr_tag != ''
        uses: docker/build-push-action@v6
        with:
          context: ./VaultwardenK8sSync
          file: ./VaultwardenK8sSync/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/vaultwarden-kubernetes-secrets:${{ steps.vars.outputs.pr_tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push to Harbor (non-PR only)
        if: github.event_name != 'pull_request'
        uses: docker/build-push-action@v6
        with:
          context: ./VaultwardenK8sSync
          file: ./VaultwardenK8sSync/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            harbor.lag0.com.br/library/vaultwarden-kubernetes-secrets:latest
            harbor.lag0.com.br/library/vaultwarden-kubernetes-secrets:${{ steps.vars.outputs.raw_tag }}
            harbor.lag0.com.br/library/vaultwarden-kubernetes-secrets:${{ steps.vars.outputs.version }}
          cache-from: type=registry,ref=harbor.lag0.com.br/library/vaultwarden-kubernetes-secrets:buildcache
          cache-to: type=registry,ref=harbor.lag0.com.br/library/vaultwarden-kubernetes-secrets:buildcache,mode=max

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.4

      - name: Helm lint chart
        run: helm lint charts/vaultwarden-kubernetes-secrets

      - name: Package Helm chart
        run: |
          mkdir -p dist
          helm package charts/vaultwarden-kubernetes-secrets \
            --version "${{ steps.vars.outputs.version }}" \
            --app-version "${{ steps.vars.outputs.version }}" \
            --destination dist

      - name: Login to GHCR (Helm OCI)
        run: echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io --username "${{ github.actor }}" --password-stdin
          
      - name: Push Helm chart to GHCR
        run: |
          CHART_FILE="dist/vaultwarden-kubernetes-secrets-${{ steps.vars.outputs.version }}.tgz"
          if [ ! -f "$CHART_FILE" ]; then
            echo "Error: Chart file $CHART_FILE not found!"
            ls -la dist/ || true
            exit 1
          fi
          helm push "$CHART_FILE" oci://ghcr.io/${{ github.repository_owner }}/charts
      
      - name: Login to Harbor (Helm OCI)
        run: echo "${{ secrets.HARBOR_PASSWORD }}" | helm registry login harbor.lag0.com.br --username "${{ secrets.HARBOR_USERNAME }}" --password-stdin
      
      - name: Push Helm chart to Harbor
        run: |
          CHART_FILE="dist/vaultwarden-kubernetes-secrets-${{ steps.vars.outputs.version }}.tgz"
          helm push "$CHART_FILE" oci://harbor.lag0.com.br/charts

  test-helm-chart:
    name: Test Helm Chart Installation
    runs-on: ubuntu-latest
    needs: [build-and-push]
    if: github.event_name == 'pull_request' || startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.4
      
      - name: Create kind cluster
        uses: helm/kind-action@v1
        with:
          cluster_name: test-cluster
          wait: 30s
      
      - name: Extract version tag
        id: vars
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            PR_NUMBER="${{ github.event.number }}"
            COMMIT_SHA="${GITHUB_SHA::8}"
            IMAGE_TAG="pr-${PR_NUMBER}-${COMMIT_SHA}"
          else
            IMAGE_TAG="${GITHUB_REF_NAME#v}"
          fi
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
      
      - name: Create test namespace
        run: kubectl create namespace vaultwarden-test
      
      - name: Create test secrets
        run: |
          kubectl create secret generic vaultwarden-kubernetes-secrets -n vaultwarden-test \
            --from-literal=BW_CLIENTID="test-client-id" \
            --from-literal=BW_CLIENTSECRET="test-client-secret" \
            --from-literal=VAULTWARDEN__MASTERPASSWORD="test-password"
      
      - name: Install Helm chart (dry-run mode)
        run: |
          helm upgrade -i vaultwarden-test ./charts/vaultwarden-kubernetes-secrets \
            --namespace vaultwarden-test \
            --set image.repository=ghcr.io/${{ github.repository_owner }}/vaultwarden-kubernetes-secrets \
            --set image.tag=${{ steps.vars.outputs.image_tag }} \
            --set env.config.VAULTWARDEN__SERVERURL="https://test.example.com" \
            --set env.config.SYNC__DRYRUN="true" \
            --set env.config.SYNC__CONTINUOUSSYNC="false" \
            --wait --timeout 2m
      
      - name: Verify deployment
        run: |
          kubectl get pods -n vaultwarden-test
          kubectl get deployment -n vaultwarden-test
          kubectl describe deployment vaultwarden-test-vaultwarden-kubernetes-secrets -n vaultwarden-test
      
      - name: Check pod logs
        if: always()
        run: |
          POD_NAME=$(kubectl get pods -n vaultwarden-test -l app.kubernetes.io/name=vaultwarden-kubernetes-secrets -o jsonpath='{.items[0].metadata.name}')
          if [ -n "$POD_NAME" ]; then
            echo "ðŸ“‹ Pod logs:"
            kubectl logs $POD_NAME -n vaultwarden-test --tail=50 || true
          fi
      
      - name: Cleanup
        if: always()
        run: kubectl delete namespace vaultwarden-test --ignore-not-found=true

  comment-pr:
    runs-on: ubuntu-latest
    needs: [build-and-push, test-helm-chart]
    if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
    permissions:
      contents: read
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate PR tag
        id: vars
        run: |
          PR_NUMBER="${{ github.event.number }}"
          COMMIT_SHA="${GITHUB_SHA::8}"
          PR_TAG="pr-${PR_NUMBER}-${COMMIT_SHA}"
          echo "pr_tag=${PR_TAG}" >> $GITHUB_OUTPUT

      - name: Comment on PR with Docker image info
        uses: actions/github-script@v7
        with:
          script: |
            const commentBody = `## âœ… PR Build & Test Complete

            **Docker Image:** \`ghcr.io/${context.repo.owner}/vaultwarden-kubernetes-secrets:${process.env.PR_TAG}\`
            
            **Helm Chart:** âœ… Tested and validated in kind cluster

            ### Quick Test Commands

            **Using Helm:**
            \`\`\`bash
            helm upgrade -i vaultwarden-test oci://ghcr.io/${context.repo.owner}/charts/vaultwarden-kubernetes-secrets \\
              --set image.tag=${process.env.PR_TAG} \\
              --set env.config.VAULTWARDEN__SERVERURL="https://your-server.com" \\
              --namespace vaultwarden-test --create-namespace
            \`\`\`

            **Using kubectl:**
            \`\`\`bash
            kubectl set image deployment/vaultwarden-kubernetes-secrets \\
              vaultwarden-kubernetes-secrets=ghcr.io/${context.repo.owner}/vaultwarden-kubernetes-secrets:${process.env.PR_TAG}
            \`\`\`

            ---
            ðŸ“¦ Build SHA: \`${process.env.GITHUB_SHA}\` | ðŸ• ${new Date().toISOString()}`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            // Check if we already commented on this PR
            const existingComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('PR Docker Image Ready for Testing')
            );
            
            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: commentBody
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }
        env:
          PR_TAG: ${{ steps.vars.outputs.pr_tag }}

      - name: Add PR image info to PR description
        uses: actions/github-script@v7
        with:
          script: |
            const dockerInfoSection = `## Docker Image for Testing

            This PR includes a pre-built Docker image for easy testing:

            Image: ghcr.io/${context.repo.owner}/vaultwarden-kubernetes-secrets:${process.env.PR_TAG}

            Quick Test Command:
            kubectl set image deployment/vaultwarden-kubernetes-secrets vaultwarden-kubernetes-secrets=ghcr.io/${context.repo.owner}/vaultwarden-kubernetes-secrets:${process.env.PR_TAG}

            ---
            `;
            
            // Add a summary to the PR description if it doesn't already have Docker info
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            if (!pr.data.body || !pr.data.body.includes('Docker Image for Testing')) {
              const newBody = pr.data.body ? `${pr.data.body}\n\n${dockerInfoSection}` : dockerInfoSection;
              
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                body: newBody
              });
            }
        env:
          PR_TAG: ${{ steps.vars.outputs.pr_tag }}
